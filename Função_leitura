#include <Arduino.h>
#include <PL_ADXL355.h>
#include <Wire.h>

//==============================================================================

// Pin connections for using SPI or I2C interface
// ADXL355 pin    Arduino pin
//                SPI     I2C
// CS/SCL          2      SCL
// MOSI/SDA       MOSI    SDA
// MISO/ASEL      MISO    GND
// SCLK/Vssio     SCLK    GND

PL::ADXL355 adxl355;
//uint8_t spiCsPin = 2;
uint8_t i2cAddress = 0x53;
uint8_t I2c_SDAPIN=21;
uint8_t I2c_SCLPIN=37;
const float L=0.5;

// ADXL355 range: +/- 2 g
auto range = PL::ADXL355_Range::range2g;

//==============================================================================

void setup() {
  
  // Initialize ADXL355 (uncomment one of the following 2 lines to use either SPI or I2C)
  //adxl355.beginSPI(spiCsPin);
  Wire.begin(I2c_SDAPIN, I2c_SCLPIN);
  adxl355.beginI2C(i2cAddress);

  // Set ADXL355 range
  adxl355.setRange(range);
  // Enable ADXL355 measurement
  adxl355.enableMeasurement();
  
  // Initialize Serial at 115200 kbps
  Serial.begin(9600);
  // Wait for Serial ready state
  while(!Serial);
}

//==============================================================================

void loop() {
  // Read and print the accelerations
  int nummedidas=10;
  int j=0;
  float xsoma=0, ysoma=0, zsoma=0;
  float xraw=0, yraw=0, zraw=0;
  float Ox=0, Oy=0, Oz=0;
  float somaOx=0, somaOy=0, somaOz=0;
  float Oxraw=0, Oyraw=0, Ozraw=0;
  float deviacaox=0, deviacaoy=0, deviacaoz=0;
  float deviacaocumulativax=0, deviacaocumulativay=0, deviacaocumulativaz=0;
  for(j=0; j<nummedidas; j++){
    auto accelerations = adxl355.getAccelerations();
    Ox = atan2(accelerations.x, sqrt(accelerations.y * accelerations.y + accelerations.z * accelerations.z)) * 180 / M_PI;
    Oy = atan2(accelerations.y, sqrt(accelerations.z * accelerations.x + accelerations.z * accelerations.z)) * 180 / M_PI;
    Oz = atan2(accelerations.z, sqrt(accelerations.x * accelerations.x + accelerations.y * accelerations.y)) * 180 / M_PI;
    deviacaox=Ox*L;
    deviacaoy=Oy*L;
    deviacaoz=Oz*L;
    somaOx+=Ox;
    somaOy+=Oy;
    somaOz+=Oz;
    xsoma+=accelerations.x;
    ysoma+=accelerations.y;
    zsoma+=accelerations.z;
    
    if(j==nummedidas-1){
      
      xraw=xsoma/(10);
      yraw=ysoma/(10);
      zraw=zsoma/(10);
      Oxraw=somaOx/(10);
      Oyraw=somaOy/(10);
      Ozraw=somaOz/(10);
      deviacaocumulativax += deviacaox;
      deviacaocumulativay += deviacaoy;
      deviacaocumulativaz += deviacaoz;
  
      Serial.print("Accelerations: X: ");
      Serial.print(xraw);
      Serial.print(" g, Y: ");
      Serial.print(yraw);
      Serial.print(" g, Z: ");
      Serial.print(zraw);
      Serial.println(" g");

      Serial.print("Angles : OX: ");
      Serial.print(Oxraw);
      Serial.print(" degrees, OY: ");
      Serial.print(Oyraw);
      Serial.print(" degrees, OZ: ");
      Serial.print(Ozraw);
      Serial.println(" degrees");

      Serial.print("Deviation : DX: ");
      Serial.print(deviacaocumulativax);
      Serial.print(" meters, DY: ");
      Serial.print(deviacaocumulativay);
      Serial.print(" meters, DZ: ");
      Serial.print(deviacaocumulativaz);
      Serial.println(" meters");
 

       
    
      Serial.println("cálculo de nova média");
    }
  }
  j=0;
  xsoma=0;
  ysoma=0;
  zsoma=0;
  somaOx=0;
  somaOy=0;
  somaOz=0;
  
  delay (1000);
}
